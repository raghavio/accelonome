let playedEmptyBuffer=!1,player=null;const IS_PHONE_APP="accelonome-android"==navigator.userAgent,DRUMS_PATTERN={4:{4:{open_hihat:{inbetween:[[],[15]],filler:[],volume:.3,duration:.4},closed_hithat:{inbetween:[[3,7,11,15]],volume:.05,duration:1},crash_cymbal:{first_bar:[1],inbetween:[],volume:.5,duration:2},kick:{inbetween:[[1,9,11]],volume:.95,duration:1},snare:{inbetween:[[5,13]],filler:[5,13,15,16],volume:1,duration:1}}},8:{6:{open_hihat:{inbetween:[[],[11]],filler:[],volume:.3,duration:.5},closed_hithat:{inbetween:[[1,3,5,7,9,11],[1,3,5,7,9]],volume:.3,duration:.5},crash_cymbal:{first_bar:[1],inbetween:[],volume:.5,duration:2},kick:{inbetween:[[1,11]],volume:.95,duration:1},snare:{inbetween:[[7]],filler:[7,9,10],volume:1,duration:1},tom:{filler:[11],inbetween:[],volume:1,duration:1}}}};function onWebAudioFontLoad(){player=new WebAudioFontPlayer}const vueApp={data:()=>({isPlaying:!1,startTempo:80,tempoUI:null,tempo:null,endTempo:160,jumpBpm:10,tempoChangeAfterX:4,noteLength:.05,nextNoteTime:0,currentBarUI:1,currentBar:1,scheduledBeats:[],note:4,beats:4,accentedBeats:[1],tempoChangeTrigger:"bar",lastTempoChangeTime:null,tickSound:"metronome_1",vibrateOn:!1,reverseEnabled:!1,isReversing:!1,shouldAccelerate:!0,drumsEnabled:!1,flashOn:!1,isPhoneApp:IS_PHONE_APP}),methods:{reset(){this.stop(),this.tempo=this.startTempo,this.tempoUI=this.tempo},stop(){timerWorker.postMessage({eventName:"clearTimeout"}),this.currentBar=1,this.currentBarUI=this.currentBar,this.isPlaying=!1,this.scheduledBeats.forEach((e=>{e.stop()})),player.cancelQueue(audioCtx),this.scheduledBeats=[],this.vibrateOn&&navigator.vibrate(0),$(".dial").stop(),IS_PHONE_APP&&this.sendDataToAndroid("stop")},play(){if(!playedEmptyBuffer){let e=audioCtx.createBuffer(1,1,22050),t=audioCtx.createBufferSource();t.buffer=e,t.connect(audioCtx.destination),t.start(0),playedEmptyBuffer=!0}SOUNDS[this.tickSound].buffer&&SOUNDS[this.tickSound+"_accent"].buffer&&(this.isPlaying=!0,!this.tempo&&(this.tempo=this.startTempo,this.tempoUI=this.startTempo,this.userEnteredTempo=this.startTempo),this.nextNoteTime=audioCtx.currentTime,this.lastTempoChangeTime=audioCtx.currentTime,this.scheduleBar(),this.performKnobAnimation(),this.vibrateOn&&this.scheduleVibration(),IS_PHONE_APP&&this.sendDataToAndroid("scheduleBar"))},scheduleBar(){this.drumsEnabled&&this.scheduleDrums();for(let e=1;e<=this.beats;e++){const t=audioCtx.createBufferSource();t.connect(metronomeGain),metronomeGain.connect(audioCtx.destination),t.buffer=this.accentedBeats.includes(e)?SOUNDS[this.tickSound+"_accent"].buffer:SOUNDS[this.tickSound].buffer,t.start(this.nextNoteTime),this.scheduledBeats.push(t),this.nextNoteTime+=this.secondsPerBeat}const e=this.nextNoteTime-audioCtx.currentTime;timerWorker.postMessage({eventName:"scheduleBar",inSeconds:e-.3}),timerWorker.postMessage({eventName:"barCompleted",inSeconds:e})},scheduleDrums(){const e=60/(4*this.tempo),t=this.currentBar==this.barsToPlay;for(const[i,s]of Object.entries(DRUMS_PATTERN[this.note][this.beats])){let n=null;if(1==this.currentBar&&"first_bar"in s)n=s.first_bar;else if(t&&"filler"in s)n=s.filler;else{if(!(1<=s.inbetween.length))continue;n=1==s.inbetween.length?s.inbetween[0]:s.inbetween[(this.currentBar-1)%2]}for(const t of n){const n=(1-.3*Math.random())*s.volume;player.queueWaveTable(audioCtx,audioCtx.destination,{zones:[SOUNDS[i]]},1/16*e+this.nextNoteTime+(t-1)*e,SOUNDS[i].originalPitch/100,s.duration,n)}}},performKnobAnimation(){if(!this.shouldAccelerate)return;if(!this.isPlaying)return;const e=this.secondsPerBeat*this.beats,t=(()=>{let t=null;switch(this.tempoChangeTrigger){case"second":return t=this.tempoChangeAfterX,t%e&&(t+=e-t%e),t;case"minute":return t=60*this.tempoChangeAfterX,t%e&&(t+=e-t%e),t;case"bar":return e*this.tempoChangeAfterX}})();this.barsToPlay=Math.round(t/e),$(".dial").stop(),$(".dial").animate({value:100},{duration:1e3*t,easing:"linear",step:function(){$(".dial").val(this.value).trigger("change")},always:function(){$(".dial").val(0).trigger("change")}})},scheduleVibration(){var e=Math.round;if(!IS_PHONE_APP){let t=[];for(let i=1;i<=this.beats;i++)this.accentedBeats.includes(i)?t.push(25,15,25,e(1e3*this.secondsPerBeat)-65):t.push(65,e(1e3*this.secondsPerBeat)-65);navigator.vibrate(t)}},sendDataToAndroid(e){let t={};"scheduleBar"==e&&(t={vibration:this.vibrateOn,flash:this.flashOn,waitTime:Array(this.beats).fill(Math.round(1e3*this.secondsPerBeat)),accentedBeats:this.accentedBeats});try{Lightation.postMessage(JSON.stringify({eventName:e,data:t}))}catch{}},barCompleted(){this.currentBar+=1,this.scheduledBeats.splice(0,4);if(this.currentBar==this.barsToPlay+1){let e=this.isReversing?this.tempo-this.jumpBpm:this.tempo+this.jumpBpm;(e>this.endTempo||e<this.startTempo)&&(e<this.startTempo?(e=this.tempo+this.jumpBpm,this.isReversing=!1):this.reverseEnabled?(this.isReversing=!0,e=this.tempo-this.jumpBpm):e=this.startTempo),this.tempo=e,this.lastTempoChangeTime=audioCtx.currentTime,this.currentBar=1}},uiVariablesUpdate(){this.tempoUI=this.tempo,this.currentBarUI=this.currentBar}},mounted(){var e=Math.min;timerWorker.onmessage=e=>{switch(e.data){case"scheduleBar":this.barCompleted(),this.scheduleBar();break;case"barCompleted":this.uiVariablesUpdate(),this.vibrateOn&&this.scheduleVibration();1==this.currentBar&&this.performKnobAnimation(),IS_PHONE_APP&&this.sendDataToAndroid("scheduleBar")}},$(".dial").knob({width:e(320,document.getElementById("playButtons").offsetWidth-30),height:e(320,document.getElementById("playButtons").offsetWidth-30),thickness:"0.10",fgColor:"#ffeb3a",readOnly:!0,bgColor:"#2295f1"}),loadOtherSounds()},computed:{secondsPerBeat:function(){const e=this.note/4;return 60/(this.tempo*e)},areDrumsAvailable:function(){const e=this.note in DRUMS_PATTERN&&this.beats in DRUMS_PATTERN[this.note];return e||(this.drumsEnabled=!1),e}},watch:{beats:function(){this.$nextTick((()=>{$(".selectpicker").selectpicker("refresh")}))},startTempo:function(){this.tempo=this.startTempo,this.tempoUI=this.tempo}}};Vue.createApp(vueApp).mount("#vue-app");
