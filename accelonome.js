let playedEmptyBuffer=!1,player=null;const IS_PHONE_APP="accelonome-android"==navigator.userAgent,DRUMS_PATTERN={4:{4:{open_hihat:{inbetween:[[],[15]],filler:[],volume:.3,duration:.4},closed_hithat:{inbetween:[[3,7,11,15]],volume:.05,duration:1},crash_cymbal:{first_bar:[1],inbetween:[],volume:.5,duration:2},kick:{inbetween:[[1,9,11]],volume:.95,duration:1},snare:{inbetween:[[5,13]],filler:[5,13,15,16],volume:1,duration:1}}},8:{6:{open_hihat:{inbetween:[[],[11]],filler:[],volume:.3,duration:.5},closed_hithat:{inbetween:[[1,3,5,7,9,11],[1,3,5,7,9]],volume:.3,duration:.5},crash_cymbal:{first_bar:[1],inbetween:[],volume:.5,duration:2},kick:{inbetween:[[1,11]],volume:.95,duration:1},snare:{inbetween:[[7]],filler:[7,9,10],volume:1,duration:1},tom:{filler:[11],inbetween:[],volume:1,duration:1}}}};function onWebAudioFontLoad(){player=new WebAudioFontPlayer}const vueApp={data(){return{isPlaying:!1,startTempo:80,tempoUI:null,tempo:null,endTempo:160,jumpBpm:10,tempoChangeAfterX:4,noteLength:.05,nextNoteTime:0,currentBarUI:1,currentBar:1,scheduledBeats:[],note:4,beats:4,accentedBeats:[1],tempoChangeTrigger:"bar",lastTempoChangeTime:null,tickSound:"metronome_1",vibrateOn:!1,reverseEnabled:!1,isReversing:!1,shouldAccelerate:!0,drumsEnabled:!1,flashOn:!1,isPhoneApp:IS_PHONE_APP}},methods:{reset(){this.stop(),this.tempo=this.startTempo,this.tempoUI=this.tempo},stop(){timerWorker.postMessage({eventName:"clearTimeout"}),this.currentBar=1,this.currentBarUI=this.currentBar,this.isPlaying=!1,this.scheduledBeats.forEach(a=>{a.stop()}),player.cancelQueue(audioCtx),this.scheduledBeats=[],this.vibrateOn&&navigator.vibrate(0),$(".dial").stop(),IS_PHONE_APP&&this.sendDataToAndroid("stop")},play(){if(!playedEmptyBuffer){let a=audioCtx.createBuffer(1,1,22050),b=audioCtx.createBufferSource();b.buffer=a,b.connect(audioCtx.destination),b.start(0),playedEmptyBuffer=!0}SOUNDS[this.tickSound].buffer&&SOUNDS[this.tickSound+"_accent"].buffer&&(this.isPlaying=!0,!this.tempo&&(this.tempo=this.startTempo,this.tempoUI=this.startTempo,this.userEnteredTempo=this.startTempo),this.nextNoteTime=audioCtx.currentTime,this.lastTempoChangeTime=audioCtx.currentTime,this.scheduleBar(),this.performKnobAnimation(),this.vibrateOn&&this.scheduleVibration(),IS_PHONE_APP&&this.sendDataToAndroid("scheduleBar"))},scheduleBar(){this.drumsEnabled&&this.scheduleDrums();for(let a=1;a<=this.beats;a++){const b=audioCtx.createBufferSource();b.connect(metronomeGain),metronomeGain.connect(audioCtx.destination),b.buffer=this.accentedBeats.includes(a)?SOUNDS[this.tickSound+"_accent"].buffer:SOUNDS[this.tickSound].buffer,b.start(this.nextNoteTime),this.scheduledBeats.push(b),this.nextNoteTime+=this.secondsPerBeat}const a=this.nextNoteTime-audioCtx.currentTime;timerWorker.postMessage({eventName:"scheduleBar",inSeconds:a-.3}),timerWorker.postMessage({eventName:"barCompleted",inSeconds:a})},scheduleDrums(){const a=60/(4*this.tempo),b=this.currentBar==this.barsToPlay;for(const[c,d]of Object.entries(DRUMS_PATTERN[this.note][this.beats])){let e=null;if(1==this.currentBar&&"first_bar"in d)e=d.first_bar;else if(b&&"filler"in d)e=d.filler;else if(1<=d.inbetween.length)e=1==d.inbetween.length?d.inbetween[0]:d.inbetween[(this.currentBar-1)%2];else continue;for(const b of e){const e=(1-.3*Math.random())*d.volume;player.queueWaveTable(audioCtx,audioCtx.destination,{zones:[SOUNDS[c]]},1/16*a+this.nextNoteTime+(b-1)*a,SOUNDS[c].originalPitch/100,d.duration,e)}}},performKnobAnimation(){if(!this.shouldAccelerate)return;if(!this.isPlaying)return;const a=this.secondsPerBeat*this.beats,b=(()=>{let b=null;switch(this.tempoChangeTrigger){case"second":return b=this.tempoChangeAfterX,b%a&&(b+=a-b%a),b;case"minute":const c=60*this.tempoChangeAfterX;return b=c,b%a&&(b+=a-b%a),b;case"bar":return a*this.tempoChangeAfterX;}})();this.barsToPlay=Math.round(b/a),$(".dial").stop(),$(".dial").animate({value:100},{duration:1e3*b,easing:"linear",step:function(){$(".dial").val(this.value).trigger("change")},always:function(){$(".dial").val(0).trigger("change")}})},scheduleVibration(){var a=Math.round;if(!IS_PHONE_APP){let b=[];for(let c=1;c<=this.beats;c++)this.accentedBeats.includes(c)?b.push(25,15,25,a(1e3*this.secondsPerBeat)-65):b.push(65,a(1e3*this.secondsPerBeat)-65);navigator.vibrate(b)}},sendDataToAndroid(a){let b={};"scheduleBar"==a&&(b={vibration:this.vibrateOn,flash:this.flashOn,waitTime:Array(this.beats).fill(Math.round(1e3*this.secondsPerBeat)),accentedBeats:this.accentedBeats});try{Lightation.postMessage(JSON.stringify({eventName:a,data:b}))}catch{}},barCompleted(){this.currentBar+=1,this.scheduledBeats.splice(0,4);const a=this.currentBar==this.barsToPlay+1;if(a){let a=this.isReversing?this.tempo-this.jumpBpm:this.tempo+this.jumpBpm;(a>this.endTempo||a<this.startTempo)&&(a<this.startTempo?(a=this.tempo+this.jumpBpm,this.isReversing=!1):this.reverseEnabled?(this.isReversing=!0,a=this.tempo-this.jumpBpm):a=this.startTempo),this.tempo=a,this.lastTempoChangeTime=audioCtx.currentTime,this.currentBar=1}},uiVariablesUpdate(){this.tempoUI=this.tempo,this.currentBarUI=this.currentBar}},mounted(){var a=Math.min;timerWorker.onmessage=a=>{switch(a.data){case"scheduleBar":this.barCompleted(),this.scheduleBar();break;case"barCompleted":this.uiVariablesUpdate(),this.vibrateOn&&this.scheduleVibration();const b=1==this.currentBar;b&&this.performKnobAnimation(),IS_PHONE_APP&&this.sendDataToAndroid("scheduleBar");}},$(".dial").knob({width:a(320,document.getElementById("playButtons").offsetWidth-30),height:a(320,document.getElementById("playButtons").offsetWidth-30),thickness:"0.10",fgColor:"#ffeb3a",readOnly:!0,bgColor:"#2295f1"}),loadOtherSounds()},computed:{secondsPerBeat:function(){const a=this.note/4,b=60/(this.tempo*a);return b},areDrumsAvailable:function(){const a=this.note in DRUMS_PATTERN&&this.beats in DRUMS_PATTERN[this.note];return a||(this.drumsEnabled=!1),a}},watch:{beats:function(){this.$nextTick(()=>{$(".selectpicker").selectpicker("refresh")})},startTempo:function(){this.tempo=this.startTempo,this.tempoUI=this.tempo}}};Vue.createApp(vueApp).mount("#vue-app");